<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Looping in successive order with Async calls | /dump</title>


<link href="https://fonts.googleapis.com/css?family=Raleway:400,700" rel="stylesheet">
<link rel="stylesheet" href="http://blog.danielcefram.com/css/style.css"/><link rel='stylesheet' href='/css/custom.css'></head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="site-title">
        <h1 class="title is-4"><a class="" href="http://blog.danielcefram.com">/dump</a></h1>
        <h4>ideas, thoughts, and rants of a software developer</h4>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile"><a class="level-item" href='mailto:dcefram@gmail.com' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://github.com/dcefram' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://linkedin.com/in/daniel-cefram-ramirez' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path stroke-width="1.8" d="m5.839218,4.101561c0,1.211972 -0.974141,2.194011 -2.176459,2.194011s-2.176459,-0.982039 -2.176459,-2.194011c0,-1.211094 0.974141,-2.194011 2.176459,-2.194011s2.176459,0.982917 2.176459,2.194011zm0.017552,3.94922l-4.388022,0l0,14.04167l4.388022,0l0,-14.04167zm7.005038,0l-4.359939,0l0,14.04167l4.360816,0l0,-7.370999c0,-4.098413 5.291077,-4.433657 5.291077,0l0,7.370999l4.377491,0l0,-8.89101c0,-6.915523 -7.829986,-6.66365 -9.669445,-3.259423l0,-1.891237z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" href='https://twitter.com/dcefram' target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <div class="subtitle is-6 is-pulled-right">
      
      
<a class="tags subtitle is-6" href="/tags/javascript">#JavaScript</a>



      
    </div>
    <h2 class="subtitle is-6">March 25, 2017</h2>
    <h1 class="title">Looping in successive order with Async calls</h1>
      
    <div class="content">
      <p>Let&rsquo;s first define an example problem to better understand the issue we have with normal looping:</p>

<p>For example, we have an array of post IDs that we would fetch and then print it out on the console</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ids</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>];

<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">id</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">ids</span>) {
  <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">API_URL</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">then</span>(() =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">results</span>);
  });
}
</code></pre></div>
<p>The output of the above code would be different results with the same id, wherein the id printed would be the last number</p>

<pre><code>4  [{ id: 1 }]
4  [{ id: 3 }]
4  [{ id: 2 }]
4  [{ id: 4 }]
</code></pre>

<p>One way to solve this is by using closures, or by simply using <code>let</code> instead of <code>var</code> to make the variable available only in that particular block</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ids</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>];

<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">id</span> <span style="color:#66d9ef">of</span> <span style="color:#a6e22e">ids</span>) {
  <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">API_URL</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">then</span>(() =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">results</span>);
  });
}
</code></pre></div>
<p>The output would be:</p>

<pre><code>1  [{ id: 1 }]
3  [{ id: 3 }]
2  [{ id: 2 }]
4  [{ id: 4 }]
</code></pre>

<p>That&rsquo;s better. The reason why we&rsquo;re printing the correct id for reach result is because the variable defined using <code>let</code> only lives on the current block, essentially behaving the same way as if we were using a function closure inside the for loop.</p>

<p>All is good, but what if we were concerned about the order?</p>

<p>Let&rsquo;s create a helper function just for this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">AsyncLoop</span>(<span style="color:#a6e22e">items</span>, <span style="color:#a6e22e">func</span>) {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">items</span>.<span style="color:#a6e22e">reduce</span>(
        (<span style="color:#a6e22e">promise</span>, <span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">index</span>) =&gt; <span style="color:#a6e22e">promise</span>.<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">previous</span> =&gt; <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">item</span>, <span style="color:#a6e22e">previous</span>, <span style="color:#a6e22e">index</span>)),
        Promise.<span style="color:#a6e22e">resolve</span>()
    );
}

<span style="color:#75715e">// Usage
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">ids</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>];

<span style="color:#a6e22e">AsyncLoop</span>(<span style="color:#a6e22e">ids</span>, <span style="color:#a6e22e">id</span> =&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">API_URL</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">id</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">response</span> =&gt; {
    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">results</span>);
    <span style="color:#66d9ef">return</span> Promise.<span style="color:#a6e22e">resolve</span>();
  });
}).<span style="color:#a6e22e">then</span>(() =&gt; <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#39;DONE!&#39;</span>));
</code></pre></div>
<p>With that, the output would be in the correct order :D</p>

<pre><code>1  [{ id: 1 }]
2  [{ id: 2 }]
3  [{ id: 3 }]
4  [{ id: 4 }]
</code></pre>

<p>The logic behind AsyncLoop function above is that it would use <code>reduce</code> to combine/reduce the array into a single value based on the accumulator function, which is the function we supply as the first parameter of <code>reduce</code>. We passed a <code>Promise.resolve</code> as the second parameter so that we would have an initial accumulator value on the first iteration of reduce (ie. the first parameter of the accumulator function), whilst returning whatever the function supplied to our helper method returns. (To learn more about reducers, read it in <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce" target="_blank">MDN&rsquo;s docs</a>)</p>

<p>In this case, the function we supply should always return a Promise for the reducer to work as expected. Basically, the function passed would only execute once the previous iteration is done. It would know that the previous iteration is done only if it returns a resolved Promise.</p>

<p>I honestly had different longer versions of this particular helper method, making use of currying, recursive functions, and function closures&hellip; The reduce method is by far the best version.</p>

    </div>
    
  </div>
</section>

<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
    <script type="text/javascript">
      var disqus_shortname = 'dcefram';
      (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="http://danielcefram.com">Daniel Cefram</a> 2017</p>
    
  </div>
</section>

</body>
</html>
